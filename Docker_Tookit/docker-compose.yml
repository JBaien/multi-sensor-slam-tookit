version: '3.8'

services:
  # timoo激光雷达驱动服务
  timoo-lidar:
    image: lidar-heading-app:latest
    container_name: timoo_lidar_container
    platform: linux/arm64
    network_mode: host
    privileged: true
    environment:
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_IP=127.0.0.1
      - TIMOO_IP=${TIMOO_IP:-192.168.188.115}
      - LANG=zh_CN.UTF-8
      - LC_ALL=zh_CN.UTF-8
      - TZ=Asia/Shanghai
    volumes:
      - ../data:/ros_ws/data:rw
      - ./configs:/ros_ws/configs:rw
      - ../timoo/src/timoo_pointcloud/launch:/opt/catkin_ws/src/timoo/timoo_pointcloud/launch:rw
    command: >
      bash -c "
        source /opt/ros/noetic/setup.bash &&
        source /opt/catkin_ws/install/setup.bash &&
        roslaunch timoo_pointcloud TM16.launch device_ip:=${TIMOO_IP}
      "
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 激光雷达目标检测服务
  lidar-target:
    image: lidar-heading-app:latest
    container_name: lidar_target_container
    platform: linux/arm64
    network_mode: host
    privileged: true
    environment:
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_IP=127.0.0.1
      - DISPLAY=${DISPLAY:-:0}
      - LANG=zh_CN.UTF-8
      - LC_ALL=zh_CN.UTF-8
      - TZ=Asia/Shanghai
    volumes:
      - ../data:/ros_ws/data:rw
      - ./configs:/ros_ws/configs:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    command: >
      bash -c "
        source /opt/ros/noetic/setup.bash &&
        source /opt/catkin_ws/install/setup.bash &&
        roslaunch lidar_target_detection lidar_target_detector.launch
      "
    restart: unless-stopped
    depends_on:
      - timoo-lidar
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 姿态估计服务
  heading-estimation:
    image: lidar-heading-app:latest
    container_name: heading_estimation_container
    platform: linux/arm64
    network_mode: host
    privileged: true
    environment:
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_IP=127.0.0.1
      - LANG=zh_CN.UTF-8
      - LC_ALL=zh_CN.UTF-8
      - TZ=Asia/Shanghai
    volumes:
      - ../data:/ros_ws/data:rw
      - ./configs:/ros_ws/configs:rw
      - ../heading_ws/src/launch:/opt/catkin_ws/src/heading_ws/launch:rw
    command: >
      bash -c "
        source /opt/ros/noetic/setup.bash &&
        source /opt/catkin_ws/install/setup.bash &&
        roslaunch heading_estimation heading_estimation.launch
      "
    restart: unless-stopped
    depends_on:
      - timoo-lidar
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
